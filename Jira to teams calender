import os
from datetime import datetime, timedelta, timezone
from flask import Flask, request, jsonify
import requests
from requests.auth import HTTPBasicAuth

app = Flask(__name__)

# ---- Jira config ----
JIRA_BASE_URL = os.environ["JIRA_BASE_URL"]              # https://your-domain.atlassian.net
JIRA_EMAIL = os.environ["JIRA_EMAIL"]
JIRA_API_TOKEN = os.environ["JIRA_API_TOKEN"]
JIRA_AUTH = HTTPBasicAuth(JIRA_EMAIL, JIRA_API_TOKEN)
JIRA_HEADERS = {"Accept": "application/json", "Content-Type": "application/json"}

# ---- Microsoft Graph config (client credentials) ----
TENANT_ID = os.environ["MS_TENANT_ID"]
CLIENT_ID = os.environ["MS_CLIENT_ID"]
CLIENT_SECRET = os.environ["MS_CLIENT_SECRET"]

def graph_get_token() -> str:
    token_url = f"https://login.microsoftonline.com/{TENANT_ID}/oauth2/v2.0/token"
    data = {
        "client_id": CLIENT_ID,
        "client_secret": CLIENT_SECRET,
        "grant_type": "client_credentials",
        "scope": "https://graph.microsoft.com/.default",
    }
    r = requests.post(token_url, data=data)
    r.raise_for_status()
    return r.json()["access_token"]

def graph_calendar_view(user_upn: str, start_dt: datetime, end_dt: datetime) -> list[dict]:
    # Microsoft Graph: list calendarView within a time range :contentReference[oaicite:4]{index=4}
    token = graph_get_token()
    url = f"https://graph.microsoft.com/v1.0/users/{user_upn}/calendarView"
    params = {
        "startDateTime": start_dt.isoformat(),
        "endDateTime": end_dt.isoformat(),
        "$select": "subject,start,end,isAllDay,showAs",
        "$top": "50",
    }
    headers = {"Authorization": f"Bearer {token}"}
    r = requests.get(url, params=params, headers=headers)
    r.raise_for_status()
    return r.json().get("value", [])

def is_out_of_office(events: list[dict]) -> bool:
    # Heuristic: Graph events often indicate availability via showAs (e.g. "oof")
    # Your tenant may label these differently. Adjust as needed.
    for ev in events:
        show_as = (ev.get("showAs") or "").lower()
        subject = (ev.get("subject") or "").lower()
        if show_as in {"oof", "outofoffice"}:
            return True
        if any(k in subject for k in ["out of office", "ooo", "vacation", "pto"]):
            return True
    return False

def jira_add_comment(issue_key: str, body: str):
    url = f"{JIRA_BASE_URL}/rest/api/3/issue/{issue_key}/comment"
    r = requests.post(url, auth=JIRA_AUTH, headers=JIRA_HEADERS, json={"body": body})
    r.raise_for_status()
    return r.json()

# --- optional: map Jira assignee -> email/UPN ---
def map_jira_assignee_to_upn(assignee_obj: dict) -> str | None:
    # Jira Cloud assignee object may include emailAddress depending on privacy settings.
    # If not present, you’ll want an internal mapping table (accountId -> email).
    return assignee_obj.get("emailAddress")

@app.post("/jira-webhook")
def jira_webhook():
    payload = request.get_json(silent=True) or {}

    # Jira: changelog is only provided for jira:issue_updated :contentReference[oaicite:5]{index=5}
    if payload.get("webhookEvent") != "jira:issue_updated":
        return jsonify({"ignored": "not issue_updated"})

    issue = payload.get("issue") or {}
    issue_key = issue.get("key")
    fields = (issue.get("fields") or {})
    assignee = fields.get("assignee")

    if not issue_key or not assignee:
        return jsonify({"ignored": "missing issue_key/assignee"})

    # Only run when assignee actually changed
    items = (payload.get("changelog") or {}).get("items") or []
    if not any(i.get("field") == "assignee" for i in items):
        return jsonify({"ignored": "assignee not changed"})

    user_upn = map_jira_assignee_to_upn(assignee)
    if not user_upn:
        return jsonify({"error": "Cannot resolve assignee to calendar identity"}), 400

    now = datetime.now(timezone.utc)
    end = now + timedelta(days=7)

    events = graph_calendar_view(user_upn, now, end)
    if is_out_of_office(events):
        msg = (
            f"Hi! This request was assigned to {assignee.get('displayName','an agent')}, "
            "but they are currently out of office. "
            "We’ll get this reassigned and follow up as soon as possible."
        )
        jira_add_comment(issue_key, msg)
        return jsonify({"status": "OOO detected, auto-replied"})

    return jsonify({"status": "No OOO, no action"})
